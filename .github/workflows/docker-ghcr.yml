name: Build and Push to GHCR

on:
  push:
    branches:
      - "master"
    tags:
      - "v*"
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build:
    name: Build (${{ matrix.arch }})
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        include:
          - arch: amd64
          - arch: arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          package_json_file: "frontend/package.json"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: "pnpm"
          cache-dependency-path: "frontend/pnpm-lock.yaml"

      - name: Build frontend
        working-directory: frontend
        run: |
          pnpm install --frozen-lockfile
          pnpm run build

      - name: Get version info
        id: version
        run: |
          VERSION=$(git describe --tags --abbrev=0 --match=v* 2>/dev/null | cut -c 2- || echo "dev")
          GIT_COMMIT=$(git log -n 1 --format=%h)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "commit=$GIT_COMMIT" >> $GITHUB_OUTPUT

      - name: Build backend
        env:
          CGO_ENABLED: "0"
          GOOS: linux
          GOARCH: ${{ matrix.arch }}
        run: |
          go build -ldflags='-s -w -X "github.com/filebrowser/filebrowser/v2/version.Version=${{ steps.version.outputs.version }}" -X "github.com/filebrowser/filebrowser/v2/version.CommitSHA=${{ steps.version.outputs.commit }}"' -o filebrowser .
          chmod +x filebrowser
          ls -la filebrowser
          file filebrowser

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ matrix.arch }}"
          docker build --platform linux/${{ matrix.arch }} -t "$IMAGE" .
          docker push "$IMAGE"

  merge:
    name: Create multi-arch manifest
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get tags
        id: tags
        run: |
          TAGS="latest"
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"
            TAGS="$TAGS $VERSION"
            MAJOR="${VERSION%%.*}"
            MINOR="${VERSION%.*}"
            TAGS="$TAGS $MAJOR $MINOR"
          fi
          echo "tags=$TAGS" >> $GITHUB_OUTPUT

      - name: Create and push manifest
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          for TAG in ${{ steps.tags.outputs.tags }}; do
            docker manifest create "$IMAGE:$TAG" \
              "$IMAGE:amd64" \
              "$IMAGE:arm64"
            docker manifest annotate "$IMAGE:$TAG" "$IMAGE:amd64" --arch amd64
            docker manifest annotate "$IMAGE:$TAG" "$IMAGE:arm64" --arch arm64
            docker manifest push "$IMAGE:$TAG"
          done
